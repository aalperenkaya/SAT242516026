@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")] @page "/admin/mukellefler" @using SAT242516026.Data @using SAT242516026.Models.DbContexts @using Microsoft.EntityFrameworkCore @inject MyDbModel_Context Db <h3 class="mb-3">Admin - Mükellefler</h3> <hr /> @if (!string.IsNullOrWhiteSpace(Message)) {
    <div class="alert alert-info">@Message</div>
}

<!-- ====== FILTER + SORT + PAGINATION ====== -->
<div class="card mb-3" >
<div class="card-header fw-bold" > Filtre / Sıralama / Sayfalama</div >
<div class="card-body" >
<div class="row g-2 align-items-end" >
<div class="col-md-2" >
<label class="form-label" > Ad</label >
<input class="form-control" @bind="F_Ad" @bind:event="oninput" / >
</div >
<div class="col-md-2" >
<label class="form-label" > VergiNo</label >
<input class="form-control" @bind="F_VergiNo" @bind:event="oninput" / >
</div >
<div class="col-md-2" >
<label class="form-label" > Tip</label >
<input class="form-control" @bind="F_Tip" @bind:event="oninput" / >
</div >
<div class="col-md-2" >
<label class="form-label" > Telefon</label >
<input class="form-control" @bind="F_Telefon" @bind:event="oninput" / >
</div >

<div class="col-md-2" >
<label class="form-label" > Sırala</label >
<select class="form-select" @bind="OrderBy" >
@foreach (var ob in OrderByItems) {
    <option value="@ob.Value">@ob.Key</option>
}

</select >
</div >

<div class="col-md-1" >
<label class="form-label" > Boyut</label >
<select class="form-select" @bind="PageSize" >
@foreach (var ps in new[] { 5, 10, 20, 50, 100 }) {
    <option value="@ps">@ps</option>
}

</select >
</div >

<div class="col-md-1" >
<button type="button" class="btn btn-primary w-100" @onclick="ApplyQuery" > Uygula</button >
</div >
</div >

<div class="d-flex justify-content-between align-items-center mt-3" >
<div class="small text-muted" >
@($"{(TotalRecordCount == 0 ? 0 : (PageNumber - 1) * PageSize + 1)} - {Math.Min(TotalRecordCount, PageNumber * PageSize)} / {TotalRecordCount}")
</div >

<div class="btn-group" >
<button type="button" class="btn btn-outline-secondary" @onclick="FirstPage" disabled="@(PageNumber<=1)" > &lt;&lt;</button >
<button type="button" class="btn btn-outline-secondary" @onclick="PrevPage" disabled="@(PageNumber<=1)" > &lt;</button >
<button type="button" class="btn btn-outline-secondary" disabled > @PageNumber / @TotalPageCount</button >
<button type="button" class="btn btn-outline-secondary" @onclick="NextPage" disabled="@(PageNumber>=TotalPageCount)" > &gt;</button >
<button type="button" class="btn btn-outline-secondary" @onclick="LastPage" disabled="@(PageNumber>=TotalPageCount)" > &gt;&gt;</button >
</div >

<button type="button" class="btn btn-outline-danger" @onclick="ResetQuery" > Sıfırla</button >
</div >
</div >
</div >
<!-- ====== CRUD FORM ====== -->
<div class="card mb-4" >
<div class="card-header fw-bold" > Mükellef (Ekle / Güncelle)</div >
<div class="card-body" >
<div class="row g-2 align-items-end" >

<div class="col-md-4" >
<label class="form-label" > Ad*</label >
<input class="form-control" @bind="mk.Ad" / >
</div >

<div class="col-md-2" >
<label class="form-label" > VergiNo</label >
<input class="form-control" @bind="mk.VergiNo" / >
</div >

<div class="col-md-2" >
<label class="form-label" > Tip</label >
<input class="form-control" @bind="mk.Tip" placeholder="Gerçek/Tüzel" / >
</div >

<div class="col-md-2" >
<label class="form-label" > Telefon</label >
<input class="form-control" @bind="mk.Telefon" / >
</div >

<div class="col-md-2" >
<label class="form-label" > Kullanıcı*</label >
<select class="form-select" @bind="mk.KullaniciId" >
<option value="0" > Seç...</option >
@foreach (var u in kullanicilar) {
    <option value="@u.Id">@u.KullaniciAdi (@u.Id)</option>
}

</select >
</div >

<div class="col-md-2 mt-2" >
<button type="button" class="btn btn-success w-100" @onclick="SaveMukellef" >
@(EditMukellefId is null ? "Ekle" : "Güncelle")
</button >

@if (EditMukellefId is not null) {
    <button type="button" class="btn btn-outline-secondary w-100 mt-2" @onclick="CancelEdit">İptal</button>
}

</div >
</div >

<hr / >
<!-- ✅ Tablo içi scroll -->
<div class="table-responsive main-scroll" >
<table class="table table-sm table-striped align-middle" >
<thead style="position: sticky; top: 0; background: white; z-index: 2;" >
<tr >
<th style="width:80px;" > Id</th >
<th > Ad</th >
<th style="width:120px;" > VergiNo</th >
<th style="width:100px;" > Tip</th >
<th style="width:120px;" > Telefon</th >
<th style="width:140px;" > KullanıcıId</th >
<th style="width:190px;" > </th >
</tr >
</thead >
<tbody >
@foreach (var m in mukellefler) {
    <tr> <td>@m.Id</td> <td>@m.Ad</td> <td>@m.VergiNo</td> <td>@m.Tip</td> <td>@m.Telefon</td> <td>@m.KullaniciId</td> <td class="text-end"> <button type="button" class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEdit(m)">Güncelle</button> <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => DeleteMukellef(m.Id)">Sil</button> </td> </tr>
}

</tbody >
</table >
</div >

</div >
</div >

@code {
    string ? Message;
    List <Kullanici> kullanicilar = new();
    List <Mukellef> mukellefler = new();
    Mukellef mk = new();
    int ? EditMukellefId;
    // Filter string? F_Ad;
    string ? F_VergiNo;
    string ? F_Tip;
    string ? F_Telefon;
    // Pagination + Sort string OrderBy = "Id desc";
    int PageSize = 10;
    int PageNumber = 1;
    int TotalRecordCount;
    int TotalPageCount => PageSize <= 0 ? 1 : Math.Max(1, (int)Math.Ceiling(TotalRecordCount / (double)PageSize));
    Dictionary <string, string> OrderByItems = new()

{

{
    "Id ↓", "Id desc"
}

,
{
    "Id ↑", "Id asc"
}

,
{
    "Ad ↑", "Ad asc"
}

,
{
    "Ad ↓", "Ad desc"
}

,
{
    "VergiNo ↑", "VergiNo asc"
}

,
{
    "VergiNo ↓", "VergiNo desc"
}

,
{
    "Tip ↑", "Tip asc"
}

,
{
    "Tip ↓", "Tip desc"
}

,
{
    "Telefon ↑", "Telefon asc"
}

,
{
    "Telefon ↓", "Telefon desc"
}

,
}

;

protected override async Task OnInitializedAsync() {
    await RefreshUsers();
    await RefreshList();
}

async Task RefreshUsers() {
    kullanicilar = await Db.Kullanicilar .OrderBy(x => x.KullaniciAdi) .AsNoTracking() .ToListAsync();
}

async Task RefreshList() {
    try

{
    IQueryable <Mukellef> q = Db.Mukellef.AsNoTracking();
    if (!string.IsNullOrWhiteSpace(F_Ad)) q = q.Where(x => x.Ad.Contains(F_Ad));
    if (!string.IsNullOrWhiteSpace(F_VergiNo)) q = q.Where(x => (x.VergiNo ?? "").Contains(F_VergiNo));
    if (!string.IsNullOrWhiteSpace(F_Tip)) q = q.Where(x => (x.Tip ?? "").Contains(F_Tip));
    if (!string.IsNullOrWhiteSpace(F_Telefon)) q = q.Where(x => (x.Telefon ?? "").Contains(F_Telefon));
    TotalRecordCount = await q.CountAsync();
    if (PageNumber < 1) PageNumber = 1;
    if (PageNumber > TotalPageCount) PageNumber = TotalPageCount;
    q = OrderBy switch

{
    "Id asc" => q.OrderBy(x => x.Id), "Id desc" => q.OrderByDescending(x => x.Id), "Ad asc" => q.OrderBy(x => x.Ad), "Ad desc" => q.OrderByDescending(x => x.Ad), "VergiNo asc" => q.OrderBy(x => x.VergiNo), "VergiNo desc" => q.OrderByDescending(x => x.VergiNo), "Tip asc" => q.OrderBy(x => x.Tip), "Tip desc" => q.OrderByDescending(x => x.Tip), "Telefon asc" => q.OrderBy(x => x.Telefon), "Telefon desc" => q.OrderByDescending(x => x.Telefon), _ => q.OrderByDescending(x => x.Id)
}

;

mukellefler = await q
.Skip((PageNumber - 1) * PageSize)
.Take(PageSize)
.ToListAsync();

Message = null;
}

catch (Exception ex) {
    Message = ex.InnerException?.Message ?? ex.Message;
}

StateHasChanged();
}

async Task ApplyQuery() {
    PageNumber = 1;
    await RefreshList();
}

async Task ResetQuery() {
    F_Ad = F_VergiNo = F_Tip = F_Telefon = null;
    OrderBy = "Id desc";
    PageSize = 10;
    PageNumber = 1;
    await RefreshList();
}

async Task FirstPage() {
    PageNumber = 1;
    await RefreshList();
}

async Task LastPage() {
    PageNumber = TotalPageCount;
    await RefreshList();
}

async Task PrevPage() {
    if (PageNumber > 1) PageNumber--;
    await RefreshList();
}

async Task NextPage() {
    if (PageNumber < TotalPageCount) PageNumber++;
    await RefreshList();
}

void StartEdit(Mukellef m) {
    EditMukellefId = m.Id;
    mk = new Mukellef

{
    Ad = m.Ad, VergiNo = m.VergiNo, Tip = m.Tip, Telefon = m.Telefon, KullaniciId = m.KullaniciId
}

;
Message = "Düzenleme modunda.";
}

void CancelEdit() {
    EditMukellefId = null;
    mk = new Mukellef();
    Message = "İptal edildi.";
}

async Task SaveMukellef() {
    if (string.IsNullOrWhiteSpace(mk.Ad))

{
    Message = "Ad zorunlu.";
    return;
}

if (mk.KullaniciId <= 0) {
    Message = "Kullanıcı seç.";
    return;
}

try {
    if (EditMukellefId is null)

{
    Db .Mukellef.Add(mk);
    await Db.SaveChangesAsync();
    Message = "Eklendi.";
}

else {
    var entity = await Db.Mukellef.FindAsync(EditMukellefId.Value);
    if (entity is null)

{
    Message = "Bulunamadı.";
    return;
}

entity.Ad = mk.Ad;
entity.VergiNo = mk.VergiNo;
entity.Tip = mk.Tip;
entity.Telefon = mk.Telefon;
entity.KullaniciId = mk.KullaniciId;

await Db.SaveChangesAsync();
Message = "Güncellendi.";
EditMukellefId = null;
}

mk = new Mukellef();
await RefreshList();
}

catch (Exception ex) {
    Message = ex.InnerException?.Message ?? ex.Message;
}

}

async Task DeleteMukellef(int id) {
    try

{
    var entity = await Db.Mukellef.FindAsync(id);
    if (entity is null)

{
    Message = "Bulunamadı.";
    return;
}

Db.Mukellef.Remove(entity);
await Db.SaveChangesAsync();
Message = "Silindi.";

if (EditMukellefId == id) {
    EditMukellefId = null;
    mk = new Mukellef();
}

await RefreshList();
}

catch (Exception ex) {
    Message = ex.InnerException?.Message ?? ex.Message;
}

}
}
