@page "/mukellefler"
@using SAT242516026.Models.DbContexts
@using Microsoft.EntityFrameworkCore
@inject MyDbModel_Context Db

<h3 class="mb-3">Mükellefler</h3>

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-info">@Message</div>
}

<div class="card mb-4">
    <div class="card-header fw-bold">Mükellef</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <input class="form-control" placeholder="Ad*" @bind="mk.Ad" />
            </div>
            <div class="col-md-2">
                <input class="form-control" placeholder="VergiNo" @bind="mk.VergiNo" />
            </div>
            <div class="col-md-2">
                <input class="form-control" placeholder="Tip (Gerçek/Tüzel)" @bind="mk.Tip" />
            </div>
            <div class="col-md-2">
                <input class="form-control" placeholder="Telefon" @bind="mk.Telefon" />
            </div>

            <div class="col-md-2">
                <button class="btn btn-success w-100" @onclick="SaveMukellef">
                    @(EditMukellefId is null ? "Ekle" : "Güncelle")
                </button>

                @if (EditMukellefId is not null)
                {
                    <button class="btn btn-outline-secondary w-100 mt-2" @onclick="CancelMukellefEdit">İptal</button>
                }
            </div>
        </div>

        <hr />

        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th style="width:80px;">Id</th>
                    <th>Ad</th>
                    <th>VergiNo</th>
                    <th>Tip</th>
                    <th>Telefon</th>
                    <th style="width:190px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in mukellefler)
                {
                    <tr>
                        <td>@m.Id</td>
                        <td>@m.Ad</td>
                        <td>@m.VergiNo</td>
                        <td>@m.Tip</td>
                        <td>@m.Telefon</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEditMukellef(m)">Güncelle</button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteMukellef(m.Id)">Sil</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    string? Message;

    List<Mukellef> mukellefler = new();
    Mukellef mk = new();

    int? EditMukellefId = null;

    protected override async Task OnInitializedAsync() => await Refresh();

    private async Task Refresh()
    {
        try
        {
            mukellefler = await Db.Mukellef
                .OrderByDescending(x => x.Id)
                .Take(50)
                .AsNoTracking()
                .ToListAsync();

            Message = null;
        }
        catch (Exception ex)
        {
            Message = ex.Message;
        }
        StateHasChanged();
    }

    private void StartEditMukellef(Mukellef m)
    {
        EditMukellefId = m.Id;

        mk = new Mukellef
            {
                Ad = m.Ad,
                VergiNo = m.VergiNo,
                Tip = m.Tip,
                Telefon = m.Telefon
            };

        Message = "Mükellef düzenleme modunda.";
    }

    private void CancelMukellefEdit()
    {
        EditMukellefId = null;
        mk = new();
        Message = "Düzenleme iptal edildi.";
    }

    private async Task SaveMukellef()
    {
        if (string.IsNullOrWhiteSpace(mk.Ad))
        {
            Message = "Mükellef Ad zorunlu.";
            return;
        }

        if (EditMukellefId is null)
        {
            Db.Mukellef.Add(mk);
            await Db.SaveChangesAsync();
            Message = "Mükellef eklendi.";
        }
        else
        {
            var entity = await Db.Mukellef.FindAsync(EditMukellefId.Value);
            if (entity is null)
            {
                Message = "Mükellef bulunamadı.";
                return;
            }

            entity.Ad = mk.Ad;
            entity.VergiNo = mk.VergiNo;
            entity.Tip = mk.Tip;
            entity.Telefon = mk.Telefon;

            await Db.SaveChangesAsync();
            Message = "Mükellef güncellendi.";

            EditMukellefId = null;
        }

        mk = new();
        await Refresh();
    }

    private async Task DeleteMukellef(int id)
    {
        var entity = await Db.Mukellef.FindAsync(id);
        if (entity is null)
        {
            Message = "Mükellef bulunamadı.";
            return;
        }

        Db.Mukellef.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Mükellef silindi.";

        if (EditMukellefId == id)
        {
            EditMukellefId = null;
            mk = new();
        }

        await Refresh();
    }
}
