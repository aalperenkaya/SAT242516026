@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@page "/admin/odemeler"

@using SAT242516026.Data
@using SAT242516026.Models.DbContexts
@using Microsoft.EntityFrameworkCore
@inject MyDbModel_Context Db

<div class="page-scroll">
    <h3 class="mb-3">Admin - Ödemeler</h3>

    @if (!string.IsNullOrWhiteSpace(Message))
    {
        <div class="alert alert-info">@Message</div>
    }

    <!-- FILTER + SORT + PAGINATION -->
    <div class="card mb-3">
        <div class="card-header fw-bold">Filtre / Sıralama / Sayfalama</div>
        <div class="card-body">
            <div class="row g-2 align-items-end">

                <div class="col-md-3">
                    <label class="form-label">TahakkukId</label>
                    <input type="number" class="form-control" @bind="F_TahakkukId" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Min Tutar</label>
                    <input type="number" step="0.01" class="form-control" @bind="F_MinTutar" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Max Tutar</label>
                    <input type="number" step="0.01" class="form-control" @bind="F_MaxTutar" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Ödeme Tarihi</label>
                    <input type="date" class="form-control" @bind="F_OdemeTarihi" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Sırala</label>
                    <select class="form-select" @bind="OrderBy">
                        @foreach (var ob in OrderByItems)
                        {
                            <option value="@ob.Value">@ob.Key</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Boyut</label>
                    <select class="form-select" @bind="PageSize">
                        @foreach (var ps in new[] { 5, 10, 20, 50, 100 })
                        {
                            <option value="@ps">@ps</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <button type="button" class="btn btn-primary w-100" @onclick="ApplyQuery">Uygula</button>
                </div>

                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger w-100" @onclick="ResetQuery">Sıfırla</button>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="small text-muted">
                    @($"{(TotalRecordCount == 0 ? 0 : (PageNumber - 1) * PageSize + 1)} - {Math.Min(TotalRecordCount, PageNumber * PageSize)} / {TotalRecordCount}")
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary" @onclick="FirstPage" disabled="@(PageNumber<=1)">&lt;&lt;</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="PrevPage" disabled="@(PageNumber<=1)">&lt;</button>
                    <button type="button" class="btn btn-outline-secondary" disabled>@PageNumber / @TotalPageCount</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="NextPage" disabled="@(PageNumber>=TotalPageCount)">&gt;</button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="LastPage" disabled="@(PageNumber>=TotalPageCount)">&gt;&gt;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CRUD -->
    <div class="card mb-5">
        <div class="card-header fw-bold">Ödeme (Ekle / Güncelle)</div>
        <div class="card-body">
            <div class="row g-2 align-items-end">

                <div class="col-md-5">
                    <label class="form-label">Tahakkuk*</label>
                    <select class="form-select" @bind="od.TahakkukId">
                        <option value="0">Seç...</option>
                        @foreach (var t in tahakkuklarLookup)
                        {
                            <option value="@t.Id">#@t.Id - @t.Tutar</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Tutar*</label>
                    <input type="number" step="0.01" class="form-control" @bind="od.Tutar" />
                </div>

                <div class="col-md-2">
                    <label class="form-label">Ödeme Tarihi</label>
                    <input type="date" class="form-control" @bind="od.OdemeTarihi" />
                </div>

                <div class="col-md-2">
                    <button type="button" class="btn btn-success w-100" @onclick="SaveOdeme">
                        @(EditId is null ? "Ekle" : "Güncelle")
                    </button>

                    @if (EditId is not null)
                    {
                        <button type="button" class="btn btn-outline-secondary w-100 mt-2" @onclick="CancelEdit">İptal</button>
                    }
                </div>
            </div>

            <hr />

            <div class="table-responsive main-scroll">
                <table class="table table-sm table-striped align-middle mb-0">
                    <thead style="position: sticky; top: 0; background: white; z-index: 2;">
                        <tr>
                            <th style="width:80px;">Id</th>
                            <th style="width:120px;">TahakkukId</th>
                            <th>Tutar</th>
                            <th>Ödeme Tarihi</th>
                            <th style="width:190px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var o in odemeler)
                        {
                            <tr>
                                <td>@o.Id</td>
                                <td>@o.TahakkukId</td>
                                <td>@o.Tutar</td>
                                <td>@(o.OdemeTarihi?.ToString("yyyy-MM-dd") ?? "-")</td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEdit(o)">Güncelle</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => DeleteOdeme(o.Id)">Sil</button>
                                </td>
                            </tr>
                        }

                        @if (odemeler.Count == 0)
                        {
                            <tr><td colspan="5" class="text-center text-muted py-3">Henüz ödeme yok.</td></tr>
                        }
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

@code {
    string? Message;

    // Dropdown lookup
    List<Tahakkuk> tahakkuklarLookup = new();

    // List
    List<Odeme> odemeler = new();

    // Form
    Odeme od = new() { Tutar = 0m };
    int? EditId;

    // Filter
    int? F_TahakkukId;
    decimal? F_MinTutar;
    decimal? F_MaxTutar;
    DateTime? F_OdemeTarihi;

    // Paging + Sort
    string OrderBy = "Id desc";
    int PageSize = 10;
    int PageNumber = 1;

    int TotalRecordCount;
    int TotalPageCount => PageSize <= 0 ? 1 : Math.Max(1, (int)Math.Ceiling(TotalRecordCount / (double)PageSize));

    Dictionary<string, string> OrderByItems = new()
    {
        { "Id ↓", "Id desc" },
        { "Id ↑", "Id asc" },
        { "Tutar ↓", "Tutar desc" },
        { "Tutar ↑", "Tutar asc" },
        { "Tarih ↓", "OdemeTarihi desc" },
        { "Tarih ↑", "OdemeTarihi asc" },
        { "TahakkukId ↓", "TahakkukId desc" },
        { "TahakkukId ↑", "TahakkukId asc" },
    };

    protected override async Task OnInitializedAsync()
    {
        await RefreshLookups();
        await RefreshList();
    }

    async Task RefreshLookups()
    {
        tahakkuklarLookup = await Db.Tahakkuk
            .OrderByDescending(x => x.Id)
            .Take(500)
            .AsNoTracking()
            .ToListAsync();
    }

    async Task RefreshList()
    {
        try
        {
            IQueryable<Odeme> q = Db.Odeme.AsNoTracking();

            if (F_TahakkukId is not null && F_TahakkukId > 0)
                q = q.Where(x => x.TahakkukId == F_TahakkukId.Value);

            if (F_MinTutar is not null)
                q = q.Where(x => x.Tutar >= F_MinTutar.Value);

            if (F_MaxTutar is not null)
                q = q.Where(x => x.Tutar <= F_MaxTutar.Value);

            if (F_OdemeTarihi is not null)
                q = q.Where(x => x.OdemeTarihi == F_OdemeTarihi.Value);

            TotalRecordCount = await q.CountAsync();

            if (PageNumber < 1) PageNumber = 1;
            if (PageNumber > TotalPageCount) PageNumber = TotalPageCount;

            q = OrderBy switch
            {
                "Id asc" => q.OrderBy(x => x.Id),
                "Id desc" => q.OrderByDescending(x => x.Id),
                "Tutar asc" => q.OrderBy(x => x.Tutar),
                "Tutar desc" => q.OrderByDescending(x => x.Tutar),
                "OdemeTarihi asc" => q.OrderBy(x => x.OdemeTarihi),
                "OdemeTarihi desc" => q.OrderByDescending(x => x.OdemeTarihi),
                "TahakkukId asc" => q.OrderBy(x => x.TahakkukId),
                "TahakkukId desc" => q.OrderByDescending(x => x.TahakkukId),
                _ => q.OrderByDescending(x => x.Id)
            };

            odemeler = await q
                .Skip((PageNumber - 1) * PageSize)
                .Take(PageSize)
                .ToListAsync();

            Message = null;
        }
        catch (Exception ex)
        {
            Message = ex.InnerException?.Message ?? ex.Message;
        }

        StateHasChanged();
    }

    async Task ApplyQuery()
    {
        PageNumber = 1;
        await RefreshList();
    }

    async Task ResetQuery()
    {
        F_TahakkukId = null;
        F_MinTutar = null;
        F_MaxTutar = null;
        F_OdemeTarihi = null;

        OrderBy = "Id desc";
        PageSize = 10;
        PageNumber = 1;

        await RefreshList();
    }

    async Task FirstPage() { PageNumber = 1; await RefreshList(); }
    async Task LastPage() { PageNumber = TotalPageCount; await RefreshList(); }
    async Task PrevPage() { if (PageNumber > 1) PageNumber--; await RefreshList(); }
    async Task NextPage() { if (PageNumber < TotalPageCount) PageNumber++; await RefreshList(); }

    void StartEdit(Odeme o)
    {
        EditId = o.Id;
        od = new() { TahakkukId = o.TahakkukId, Tutar = o.Tutar, OdemeTarihi = o.OdemeTarihi };
        Message = "Düzenleme modunda.";
    }

    void CancelEdit()
    {
        EditId = null;
        od = new() { Tutar = 0m };
        Message = "İptal edildi.";
    }

    async Task SaveOdeme()
    {
        if (od.TahakkukId <= 0) { Message = "Tahakkuk seç."; return; }
        if (od.Tutar < 0) { Message = "Tutar negatif olamaz."; return; }

        try
        {
            if (EditId is null)
            {
                Db.Odeme.Add(od);
                await Db.SaveChangesAsync();
                Message = "Eklendi.";
            }
            else
            {
                var entity = await Db.Odeme.FindAsync(EditId.Value);
                if (entity is null) { Message = "Bulunamadı."; return; }

                entity.TahakkukId = od.TahakkukId;
                entity.Tutar = od.Tutar;
                entity.OdemeTarihi = od.OdemeTarihi;

                await Db.SaveChangesAsync();
                Message = "Güncellendi.";
                EditId = null;
            }

            od = new() { Tutar = 0m };
            await RefreshList();
        }
        catch (Exception ex)
        {
            Message = ex.InnerException?.Message ?? ex.Message;
        }
    }

    async Task DeleteOdeme(int id)
    {
        try
        {
            var entity = await Db.Odeme.FindAsync(id);
            if (entity is null) { Message = "Bulunamadı."; return; }

            Db.Odeme.Remove(entity);
            await Db.SaveChangesAsync();
            Message = "Silindi.";

            if (EditId == id) { EditId = null; od = new() { Tutar = 0m }; }
            await RefreshList();
        }
        catch (Exception ex)
        {
            Message = ex.InnerException?.Message ?? ex.Message;
        }
    }
}
