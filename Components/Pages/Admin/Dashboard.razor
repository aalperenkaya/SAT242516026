@page "/admin/dashboard"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

@using Microsoft.EntityFrameworkCore
@using SAT242516026.Models.DbContexts
@inject MyDbModel_Context Db
@inject IJSRuntime JS

<h3 class="mb-3">Admin Dashboard</h3>

<div class="row g-3">

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header fw-bold">Kayıt Sayıları</div>
            <div class="card-body" style="height:260px;">
                <canvas id="chartBar1"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header fw-bold">Duruma Göre Beyanname</div>
            <div class="card-body" style="height:260px;">
                <canvas id="chartBarDurum"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header fw-bold">Tahakkuk / Ödeme / Kalan</div>
            <div class="card-body" style="height:260px;">
                <canvas id="chartBarFin"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header fw-bold">Aylara Göre Ödeme</div>
            <div class="card-body" style="height:260px;">
                <canvas id="chartLineAy"></canvas>
            </div>
        </div>
    </div>

</div>

@code {
    bool _drawn;

    public class ChartSeries
    {
        public string label { get; set; } = string.Empty;
        public double[] data { get; set; } = Array.Empty<double>();
        public string backgroundColor { get; set; } = "rgba(0,127,0,0.35)";
        public string borderColor { get; set; } = "rgba(0,127,0,1)";
        public int borderWidth { get; set; } = 1;
        public bool fill { get; set; } = false;
        public double? tension { get; set; }
    }
    private ChartSeries[] GetSeriesList(
        string label,
        IEnumerable<double> data,
        string backgroundColor = "rgba(0,127,0,0.35)",
        string borderColor = "rgba(0,127,0,1)",
        int borderWidth = 1,
        bool fill = false,
        double? tension = null
    )
    {
        return new[]
        {
            new ChartSeries
            {
                label = label,
                data = data.ToArray(),
                backgroundColor = backgroundColor,
                borderColor = borderColor,
                borderWidth = borderWidth,
                fill = fill,
                tension = tension
            }
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _drawn) return;
        _drawn = true;

        // 1) Kayıt sayıları
        var mukellefCount = await Db.Mukellef.CountAsync();
        var beyannameCount = await Db.Beyanname.CountAsync();
        var tahakkukCount = await Db.Tahakkuk.CountAsync();
        var odemeCount = await Db.Odeme.CountAsync();

        await JS.InvokeVoidAsync(
            "drawBarChart",
            "chartBar1",
            new[] { "Mükellef", "Beyanname", "Tahakkuk", "Ödeme" },
            GetSeriesList("Toplam", new double[] {
                mukellefCount, beyannameCount, tahakkukCount, odemeCount
            }),
            true, true, "x"
        );

        // 2) Duruma göre beyanname
        var durumList = await Db.Beyanname
            .GroupBy(x => x.Durum ?? "Bilinmiyor")
            .Select(g => new { g.Key, Cnt = g.Count() })
            .ToListAsync();

        await JS.InvokeVoidAsync(
            "drawBarChart",
            "chartBarDurum",
            durumList.Select(x => x.Key).ToArray(),
            GetSeriesList("Adet", durumList.Select(x => (double)x.Cnt)),
            true, true, "x"
        );

        // 3) Tahakkuk / Ödeme / Kalan
        var toplamTahakkuk = await Db.Tahakkuk.SumAsync(x => (decimal?)x.Tutar) ?? 0;
        var toplamOdeme = await Db.Odeme.SumAsync(x => (decimal?)x.Tutar) ?? 0;

        await JS.InvokeVoidAsync(
            "drawBarChart",
            "chartBarFin",
            new[] { "Tahakkuk", "Ödeme", "Kalan" },
            GetSeriesList("Tutar", new double[] {
                (double)toplamTahakkuk,
                (double)toplamOdeme,
                (double)(toplamTahakkuk - toplamOdeme)
            }),
            true, true, "x"
        );

        // 4) Aylara göre ödeme (Line)
        var odemeler = await Db.Odeme
            .Where(x => x.OdemeTarihi != null)
            .Select(x => new { x.OdemeTarihi!.Value, x.Tutar })
            .ToListAsync();

        var now = DateTime.Now;
        var months = Enumerable.Range(0, 12)
            .Select(i => new DateTime(now.Year, now.Month, 1).AddMonths(-11 + i))
            .ToList();

        var map = months.ToDictionary(m => (m.Year, m.Month), _ => 0m);

        foreach (var o in odemeler)
            if (map.ContainsKey((o.Value.Year, o.Value.Month)))
                map[(o.Value.Year, o.Value.Month)] += o.Tutar;

        await JS.InvokeVoidAsync(
            "drawLineChart",
            "chartLineAy",
            months.Select(m => m.ToString("MM.yyyy")).ToArray(),
            GetSeriesList(
                "Ödeme",
                months.Select(m => (double)map[(m.Year, m.Month)]),
                backgroundColor: "rgba(0,127,0,0.15)",
                borderColor: "rgba(0,127,0,1)",
                borderWidth: 2,
                fill: true,
                tension: 0.25
            ),
            true, true, true, 0.25
        );
    }
}
