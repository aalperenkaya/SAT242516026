@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@page "/admin/tahakkuklar"

@using SAT242516026.Data
@using SAT242516026.Models.DbContexts
@using Microsoft.EntityFrameworkCore
@inject MyDbModel_Context Db

<h3 class="mb-3">Admin - Tahakkuklar</h3>
<hr />

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-info">@Message</div>
}

<!-- ====== FILTER + SORT + PAGINATION ====== -->
<div class="card mb-3">
    <div class="card-header fw-bold">Filtre / Sıralama / Sayfalama</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">

            <div class="col-md-2">
                <label class="form-label">BeyannameId</label>
                <input type="number" class="form-control" @bind="F_BeyannameId" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Min Tutar</label>
                <input type="number" step="0.01" class="form-control" @bind="F_MinTutar" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Max Tutar</label>
                <input type="number" step="0.01" class="form-control" @bind="F_MaxTutar" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Tarih</label>
                <input type="date" class="form-control" @bind="F_Tarih" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Sırala</label>
                <select class="form-select" @bind="OrderBy">
                    @foreach (var ob in OrderByItems)
                    {
                        <option value="@ob.Value">@ob.Key</option>
                    }
                </select>
            </div>

            <div class="col-md-1">
                <label class="form-label">Boyut</label>
                <select class="form-select" @bind="PageSize">
                    @foreach (var ps in new[] { 5, 10, 20, 50, 100 })
                    {
                        <option value="@ps">@ps</option>
                    }
                </select>
            </div>

            <div class="col-md-1">
                <button type="button" class="btn btn-primary w-100" @onclick="ApplyQuery">Uygula</button>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="small text-muted">
                @($"{(TotalRecordCount == 0 ? 0 : (PageNumber - 1) * PageSize + 1)} - {Math.Min(TotalRecordCount, PageNumber * PageSize)} / {TotalRecordCount}")
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary" @onclick="FirstPage" disabled="@(PageNumber<=1)">&lt;&lt;</button>
                <button type="button" class="btn btn-outline-secondary" @onclick="PrevPage" disabled="@(PageNumber<=1)">&lt;</button>
                <button type="button" class="btn btn-outline-secondary" disabled>@PageNumber / @TotalPageCount</button>
                <button type="button" class="btn btn-outline-secondary" @onclick="NextPage" disabled="@(PageNumber>=TotalPageCount)">&gt;</button>
                <button type="button" class="btn btn-outline-secondary" @onclick="LastPage" disabled="@(PageNumber>=TotalPageCount)">&gt;&gt;</button>
            </div>

            <button type="button" class="btn btn-outline-danger" @onclick="ResetQuery">Sıfırla</button>
        </div>
    </div>
</div>

<!-- ====== CRUD ====== -->
<div class="card mb-4">
    <div class="card-header fw-bold">Tahakkuk (Ekle / Güncelle)</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">

            <div class="col-md-5">
                <label class="form-label">Beyanname*</label>
                <select class="form-select" @bind="th.BeyannameId">
                    <option value="0">Seç...</option>
                    @foreach (var b in beyannameler)
                    {
                        <option value="@b.Id">#@b.Id - @b.Mukellef?.Ad - @b.BeyannameTipi?.Ad (@b.Yil)</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Tutar*</label>
                <input type="number" step="0.01" class="form-control" @bind="th.Tutar" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Tarih</label>
                <input type="date" class="form-control" @bind="th.Tarih" />
            </div>

            <div class="col-md-2">
                <button type="button" class="btn btn-success w-100" @onclick="SaveTahakkuk">
                    @(EditId is null ? "Ekle" : "Güncelle")
                </button>

                @if (EditId is not null)
                {
                    <button type="button" class="btn btn-outline-secondary w-100 mt-2" @onclick="CancelEdit">İptal</button>
                }
            </div>
        </div>

        <hr />

        <div class="table-responsive main-scroll">
            <table class="table table-sm table-striped align-middle mb-0">
                <thead style="position: sticky; top: 0; background: white; z-index: 2;">
                    <tr>
                        <th style="width:80px;">Id</th>
                        <th style="width:120px;">BeyannameId</th>
                        <th>Tutar</th>
                        <th>Tarih</th>
                        <th style="width:190px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var t in tahakkuklar)
                    {
                        <tr>
                            <td>@t.Id</td>
                            <td>@t.BeyannameId</td>
                            <td>@t.Tutar</td>
                            <td>@(t.Tarih?.ToString("yyyy-MM-dd") ?? "-")</td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEdit(t)">Güncelle</button>
                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTahakkuk(t.Id)">Sil</button>
                            </td>
                        </tr>
                    }

                    @if (tahakkuklar.Count == 0)
                    {
                        <tr><td colspan="5" class="text-center text-muted py-3">Kayıt yok.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    string? Message;

    // dropdown
    List<Beyanname> beyannameler = new();

    // list
    List<Tahakkuk> tahakkuklar = new();

    // model
    Tahakkuk th = new() { Tutar = 0m };
    int? EditId;

    // Filters
    int? F_BeyannameId;
    decimal? F_MinTutar;
    decimal? F_MaxTutar;
    DateTime? F_Tarih;

    // Paging + Sort
    string OrderBy = "Id desc";
    int PageSize = 10;
    int PageNumber = 1;

    int TotalRecordCount;
    int TotalPageCount => PageSize <= 0 ? 1 : Math.Max(1, (int)Math.Ceiling(TotalRecordCount / (double)PageSize));

    Dictionary<string, string> OrderByItems = new()
    {
        { "Id ↓", "Id desc" },
        { "Id ↑", "Id asc" },
        { "Tutar ↓", "Tutar desc" },
        { "Tutar ↑", "Tutar asc" },
        { "Tarih ↓", "Tarih desc" },
        { "Tarih ↑", "Tarih asc" },
        { "BeyannameId ↑", "BeyannameId asc" },
        { "BeyannameId ↓", "BeyannameId desc" },
    };

    protected override async Task OnInitializedAsync()
    {
        await RefreshBeyannameDropdown();
        await RefreshList();
    }

    async Task RefreshBeyannameDropdown()
    {
        beyannameler = await Db.Beyanname
            .Include(x => x.Mukellef)
            .Include(x => x.BeyannameTipi)
            .OrderByDescending(x => x.Id)
            .Take(500)
            .AsNoTracking()
            .ToListAsync();
    }

    async Task RefreshList()
    {
        try
        {
            IQueryable<Tahakkuk> q = Db.Tahakkuk.AsNoTracking();

            if (F_BeyannameId is not null && F_BeyannameId > 0)
                q = q.Where(x => x.BeyannameId == F_BeyannameId);

            if (F_MinTutar is not null)
                q = q.Where(x => x.Tutar >= F_MinTutar);

            if (F_MaxTutar is not null)
                q = q.Where(x => x.Tutar <= F_MaxTutar);

            if (F_Tarih is not null)
                q = q.Where(x => x.Tarih == F_Tarih);

            TotalRecordCount = await q.CountAsync();

            if (PageNumber < 1) PageNumber = 1;
            if (PageNumber > TotalPageCount) PageNumber = TotalPageCount;

            q = OrderBy switch
            {
                "Id asc" => q.OrderBy(x => x.Id),
                "Id desc" => q.OrderByDescending(x => x.Id),
                "Tutar asc" => q.OrderBy(x => x.Tutar),
                "Tutar desc" => q.OrderByDescending(x => x.Tutar),
                "Tarih asc" => q.OrderBy(x => x.Tarih),
                "Tarih desc" => q.OrderByDescending(x => x.Tarih),
                "BeyannameId asc" => q.OrderBy(x => x.BeyannameId),
                "BeyannameId desc" => q.OrderByDescending(x => x.BeyannameId),
                _ => q.OrderByDescending(x => x.Id)
            };

            tahakkuklar = await q
                .Skip((PageNumber - 1) * PageSize)
                .Take(PageSize)
                .ToListAsync();

            Message = null;
        }
        catch (Exception ex)
        {
            Message = ex.InnerException?.Message ?? ex.Message;
        }
    }

    async Task ApplyQuery() { PageNumber = 1; await RefreshList(); }

    async Task ResetQuery()
    {
        F_BeyannameId = null;
        F_MinTutar = null;
        F_MaxTutar = null;
        F_Tarih = null;
        OrderBy = "Id desc";
        PageSize = 10;
        PageNumber = 1;
        await RefreshList();
    }

    async Task FirstPage() { PageNumber = 1; await RefreshList(); }
    async Task LastPage() { PageNumber = TotalPageCount; await RefreshList(); }
    async Task PrevPage() { if (PageNumber > 1) PageNumber--; await RefreshList(); }
    async Task NextPage() { if (PageNumber < TotalPageCount) PageNumber++; await RefreshList(); }

    void StartEdit(Tahakkuk t)
    {
        EditId = t.Id;
        th = new() { BeyannameId = t.BeyannameId, Tutar = t.Tutar, Tarih = t.Tarih };
        Message = "Düzenleme modunda.";
    }

    void CancelEdit()
    {
        EditId = null;
        th = new() { Tutar = 0m };
        Message = "İptal edildi.";
    }

    async Task SaveTahakkuk()
    {
        if (th.BeyannameId <= 0) { Message = "Beyanname seç."; return; }
        if (th.Tutar < 0) { Message = "Tutar negatif olamaz."; return; }

        try
        {
            if (EditId is null)
                Db.Tahakkuk.Add(th);
            else
            {
                var entity = await Db.Tahakkuk.FindAsync(EditId.Value);
                if (entity is null) { Message = "Bulunamadı."; return; }

                entity.BeyannameId = th.BeyannameId;
                entity.Tutar = th.Tutar;
                entity.Tarih = th.Tarih;
            }

            await Db.SaveChangesAsync();
            Message = EditId is null ? "Eklendi." : "Güncellendi.";
            EditId = null;
            th = new() { Tutar = 0m };

            await RefreshList();
        }
        catch (Exception ex)
        {
            Message = ex.InnerException?.Message ?? ex.Message;
        }
    }

    async Task DeleteTahakkuk(int id)
    {
        try
        {
            var hasOdeme = await Db.Odeme.AnyAsync(o => o.TahakkukId == id);
            if (hasOdeme) { Message = "Bu tahakkuka bağlı ödeme var. Önce ödemeleri silmelisin."; return; }

            var entity = await Db.Tahakkuk.FindAsync(id);
            if (entity is null) { Message = "Bulunamadı."; return; }

            Db.Tahakkuk.Remove(entity);
            await Db.SaveChangesAsync();
            Message = "Silindi.";

            if (EditId == id) { EditId = null; th = new() { Tutar = 0m }; }

            await RefreshList();
        }
        catch (Exception ex)
        {
            Message = ex.InnerException?.Message ?? ex.Message;
        }
    }
}
