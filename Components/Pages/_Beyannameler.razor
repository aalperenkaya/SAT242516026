@page "/beyannameler"
@using System
@using System.Collections.Generic
@using System.Linq
@using SAT242516026.Data
@using SAT242516026.Models.DbContexts
@using Microsoft.EntityFrameworkCore
@inject MyDbModel_Context Db

<h3 class="mb-3">Beyannameler | Test Ekranı</h3>

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-info">@Message</div>
}

<div class="row g-3 mb-4">
    <div class="col-md-2">
        <div class="card">
            <div class="card-body">
                <div class="fw-bold">Mükellef</div>
                <div>@counts.Mukellef</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body">
                <div class="fw-bold">Beyanname Tipi</div>
                <div>@counts.BeyannameTipi</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body">
                <div class="fw-bold">Beyanname</div>
                <div>@counts.Beyanname</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body">
                <div class="fw-bold">Tahakkuk</div>
                <div>@counts.Tahakkuk</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body">
                <div class="fw-bold">Ödeme</div>
                <div>@counts.Odeme</div>
            </div>
        </div>
    </div>
</div>

<div class="d-flex gap-2 mb-4">
    <button class="btn btn-primary" @onclick="Seed">Örnek Verileri Yükle</button>
    <button class="btn btn-outline-secondary" @onclick="Refresh">Yenile</button>
</div>

<div class="card mb-4">
    <div class="card-header fw-bold">Mükellef Ekle</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4"><input class="form-control" placeholder="Ad*" @bind="mk.Ad" /></div>
            <div class="col-md-2"><input class="form-control" placeholder="VergiNo" @bind="mk.VergiNo" /></div>
            <div class="col-md-2"><input class="form-control" placeholder="Tip (Gerçek/Tüzel)" @bind="mk.Tip" /></div>
            <div class="col-md-2"><input class="form-control" placeholder="Telefon" @bind="mk.Telefon" /></div>
            <div class="col-md-2"><button class="btn btn-success w-100" @onclick="AddMukellef">Ekle</button></div>
        </div>
        <hr />
        <table class="table table-sm table-striped">
            <thead><tr><th>Id</th><th>Ad</th><th>VergiNo</th><th>Tip</th><th>Telefon</th><th></th></tr></thead>
            <tbody>
                @foreach (var m in mukellefler)
                {
                    <tr>
                        <td>@m.Id</td>  
                        <td>@m.Ad</td>
                        <td>@m.VergiNo</td>
                        <td>@m.Tip</td>
                        <td>@m.Telefon</td>
                        <td class="text-end"><button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteMukellef(m.Id)">Sil</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header fw-bold">Beyanname Tipi Ekle</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-6"><input class="form-control" placeholder="Ad*" @bind="bt.Ad" /></div>
            <div class="col-md-2"><button class="btn btn-success w-100" @onclick="AddBeyannameTipi">Ekle</button></div>
        </div>
        <hr />
        <table class="table table-sm table-striped">
            <thead><tr><th>Id</th><th>Ad</th><th></th></tr></thead>
            <tbody>
                @foreach (var t in beyannameTipleri)
                {
                    <tr>
                        <td>@t.Id</td>
                        <td>@t.Ad</td>
                        <td class="text-end"><button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteBeyannameTipi(t.Id)">Sil</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header fw-bold">Beyanname Ekle</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Mükellef*</label>
                <select class="form-select" @bind="bn.MukellefId">
                    <option value="0">Seç...</option>
                    @foreach (var m in mukellefler)
                    {
                        <option value="@m.Id">@m.Ad (@m.Id)</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Beyanname Tipi*</label>
                <select class="form-select" @bind="bn.BeyannameTipiId">
                    <option value="0">Seç...</option>
                    @foreach (var t in beyannameTipleri)
                    {
                        <option value="@t.Id">@t.Ad (@t.Id)</option>
                    }
                </select>
            </div>
            <div class="col-md-2"><label class="form-label">Yıl*</label><input type="number" class="form-control" @bind="bn.Yil" /></div>
            <div class="col-md-2"><label class="form-label">Dönem</label><input class="form-control" placeholder="01, 2025-10, Q3..." @bind="bn.Donem" /></div>
            <div class="col-md-2"><label class="form-label">Durum</label><input class="form-control" placeholder="Taslak/Verildi..." @bind="bn.Durum" /></div>
            <div class="col-md-3"><label class="form-label">Son Gönderme</label><input type="date" class="form-control" @bind="bn.SonGondermeTarihi" /></div>
            <div class="col-md-3"><label class="form-label">Gönderme</label><input type="date" class="form-control" @bind="bn.GondermeTarihi" /></div>
            <div class="col-md-2"><button class="btn btn-success w-100" @onclick="AddBeyanname">Ekle</button></div>
        </div>
        <hr />
        <table class="table table-sm table-striped">
            <thead><tr><th>Id</th><th>Mükellef</th><th>Tip</th><th>Yıl</th><th>Dönem</th><th>Durum</th><th></th></tr></thead>
            <tbody>
                @foreach (var b in beyannameler)
                {
                    <tr>
                        <td>@b.Id</td>
                        <td>@b.Mukellef?.Ad (@b.MukellefId)</td>
                        <td>@b.BeyannameTipi?.Ad (@b.BeyannameTipiId)</td>
                        <td>@b.Yil</td>
                        <td>@b.Donem</td>
                        <td>@b.Durum</td>
                        <td class="text-end"><button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteBeyanname(b.Id)">Sil</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header fw-bold">Tahakkuk Ekle</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Beyanname*</label>
                <select class="form-select" @bind="th.BeyannameId">
                    <option value="0">Seç...</option>
                    @foreach (var b in beyannameler)
                    {
                        <option value="@b.Id">#@b.Id - @b.Mukellef?.Ad - @b.BeyannameTipi?.Ad</option>
                    }
                </select>
            </div>
            <div class="col-md-2"><label class="form-label">Tutar*</label><input type="number" step="0.01" class="form-control" @bind="th.Tutar" /></div>
            <div class="col-md-3"><label class="form-label">Tarih</label><input type="date" class="form-control" @bind="th.Tarih" /></div>
            <div class="col-md-2"><button class="btn btn-success w-100" @onclick="AddTahakkuk">Ekle</button></div>
        </div>
        <hr />
        <table class="table table-sm table-striped">
            <thead><tr><th>Id</th><th>BeyannameId</th><th>Tutar</th><th>Tarih</th><th></th></tr></thead>
            <tbody>
                @foreach (var t in tahakkuklar)
                {
                    <tr>
                        <td>@t.Id</td>
                        <td>@t.BeyannameId</td>
                        <td>@t.Tutar.ToString("C")</td>
                        <td>@t.Tarih?.ToString("yyyy-MM-dd")</td>
                        <td class="text-end"><button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTahakkuk(t.Id)">Sil</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="card mb-5">
    <div class="card-header fw-bold">Ödeme Ekle</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Tahakkuk*</label>
                <select class="form-select" @bind="od.TahakkukId">
                    <option value="0">Seç...</option>
                    @foreach (var t in tahakkuklar)
                    {
                        <option value="@t.Id">#@t.Id - @t.Tutar</option>
                    }
                </select>
            </div>
            <div class="col-md-2"><label class="form-label">Tutar*</label><input type="number" step="0.01" class="form-control" @bind="od.Tutar" /></div>
            <div class="col-md-3"><label class="form-label">Ödeme Tarihi</label><input type="date" class="form-control" @bind="od.OdemeTarihi" /></div>
            <div class="col-md-2"><button class="btn btn-success w-100" @onclick="AddOdeme">Ekle</button></div>
        </div>
        <hr />
        <table class="table table-sm table-striped">
            <thead><tr><th>Id</th><th>TahakkukId</th><th>Tutar</th><th>Ödeme Tarihi</th><th></th></tr></thead>
            <tbody>
                @foreach (var o in odemeler)
                {
                    <tr>
                        <td>@o.Id</td>
                        <td>@o.TahakkukId</td>
                        <td>@o.Tutar.ToString("C")</td>
                        <td>@o.OdemeTarihi?.ToString("yyyy-MM-dd")</td>
                        <td class="text-end"><button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteOdeme(o.Id)">Sil</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    string? Message;

    List<Mukellef> mukellefler = new();
    List<BeyannameTipi> beyannameTipleri = new();
    List<Beyanname> beyannameler = new();
    List<Tahakkuk> tahakkuklar = new();
    List<Odeme> odemeler = new();

    Mukellef mk = new();
    BeyannameTipi bt = new();
    Beyanname bn = new() { Yil = DateTime.Now.Year };
    Tahakkuk th = new() { Tutar = 0m };
    Odeme od = new() { Tutar = 0m };

    (int Mukellef, int BeyannameTipi, int Beyanname, int Tahakkuk, int Odeme) counts;

    protected override async Task OnInitializedAsync() => await Refresh();

    private async Task Refresh()
    {
        try
        {
            mukellefler = await Db.Mukellef.OrderByDescending(x => x.Id).Take(50).AsNoTracking().ToListAsync();
            beyannameTipleri = await Db.BeyannameTipi.OrderByDescending(x => x.Id).Take(50).AsNoTracking().ToListAsync();
            beyannameler = await Db.Beyanname.Include(x => x.Mukellef).Include(x => x.BeyannameTipi).OrderByDescending(x => x.Id).Take(50).AsNoTracking().ToListAsync();
            tahakkuklar = await Db.Tahakkuk.OrderByDescending(x => x.Id).Take(50).AsNoTracking().ToListAsync();
            odemeler = await Db.Odeme.OrderByDescending(x => x.Id).Take(50).AsNoTracking().ToListAsync();

            counts = (
                await Db.Mukellef.CountAsync(),
                await Db.BeyannameTipi.CountAsync(),
                await Db.Beyanname.CountAsync(),
                await Db.Tahakkuk.CountAsync(),
                await Db.Odeme.CountAsync()
            );

            Message = null;
        }
        catch (Exception ex)
        {
            Message = ex.Message;
        }
        StateHasChanged();
    }

    private async Task Seed()
    {
        if (!await Db.Mukellef.AnyAsync())
        {
            Db.Mukellef.AddRange(
                new Mukellef { Ad = "ACME Ltd.", VergiNo = "1234567890", Tip = "Tüzel", Telefon = "0212 000 00 00" },
                new Mukellef { Ad = "Ayşe Yılmaz", VergiNo = "11111111111", Tip = "Gerçek", Telefon = "0532 000 00 00" }
            );
        }
        if (!await Db.BeyannameTipi.AnyAsync())
        {
            Db.BeyannameTipi.AddRange(new BeyannameTipi { Ad = "KDV 1" }, new BeyannameTipi { Ad = "Muhtasar" });
        }
        await Db.SaveChangesAsync();

        var m = await Db.Mukellef.FirstAsync();
        var t = await Db.BeyannameTipi.FirstAsync();

        var b = new Beyanname
            {
                MukellefId = m.Id,
                BeyannameTipiId = t.Id,
                Yil = DateTime.Now.Year,
                Donem = "10",
                Durum = "Taslak",
                SonGondermeTarihi = DateTime.Today.AddDays(7)
            };
        Db.Beyanname.Add(b);
        await Db.SaveChangesAsync();

        var tah = new Tahakkuk { BeyannameId = b.Id, Tutar = 1500m, Tarih = DateTime.Today };
        Db.Tahakkuk.Add(tah);
        await Db.SaveChangesAsync();

        var odeme = new Odeme { TahakkukId = tah.Id, Tutar = 500m, OdemeTarihi = DateTime.Today };
        Db.Odeme.Add(odeme);
        await Db.SaveChangesAsync();

        Message = "Örnek kayıtlar eklendi.";
        await Refresh();
    }

    private async Task AddMukellef()
    {
        if (string.IsNullOrWhiteSpace(mk.Ad)) { Message = "Mükellef Ad zorunlu."; return; }
        Db.Mukellef.Add(mk);
        await Db.SaveChangesAsync();
        mk = new();
        Message = "Mükellef eklendi.";
        await Refresh();
    }

    private async Task AddBeyannameTipi()
    {
        if (string.IsNullOrWhiteSpace(bt.Ad)) { Message = "Beyanname Tipi Ad zorunlu."; return; }
        Db.BeyannameTipi.Add(bt);
        await Db.SaveChangesAsync();
        bt = new();
        Message = "Beyanname Tipi eklendi.";
        await Refresh();
    }

    private async Task AddBeyanname()
    {
        if (bn.MukellefId <= 0 || bn.BeyannameTipiId <= 0 || bn.Yil <= 0)
        { Message = "Mükellef, Tip ve Yıl zorunlu."; return; }

        Db.Beyanname.Add(bn);
        await Db.SaveChangesAsync();
        bn = new() { Yil = DateTime.Now.Year };
        Message = "Beyanname eklendi.";
        await Refresh();
    }

    private async Task AddTahakkuk()
    {
        if (th.BeyannameId <= 0) { Message = "Beyanname seç."; return; }
        if (th.Tutar < 0) { Message = "Tutar negatif olamaz."; return; }

        Db.Tahakkuk.Add(th);
        await Db.SaveChangesAsync();
        th = new() { Tutar = 0m };
        Message = "Tahakkuk eklendi.";
        await Refresh();
    }

    private async Task AddOdeme()
    {
        if (od.TahakkukId <= 0) { Message = "Tahakkuk seç."; return; }
        if (od.Tutar < 0) { Message = "Tutar negatif olamaz."; return; }

        Db.Odeme.Add(od);
        await Db.SaveChangesAsync();
        od = new() { Tutar = 0m };
        Message = "Ödeme eklendi.";
        await Refresh();
    }

    private async Task DeleteMukellef(int id)
    {
        var entity = await Db.Mukellef.FindAsync(id);
        if (entity is null) { Message = "Mükellef bulunamadı."; return; }
        Db.Mukellef.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Mükellef silindi.";
        await Refresh();
    }

    private async Task DeleteBeyannameTipi(int id)
    {
        var entity = await Db.BeyannameTipi.FindAsync(id);
        if (entity is null) { Message = "Beyanname Tipi bulunamadı."; return; }
        Db.BeyannameTipi.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Beyanname Tipi silindi.";
        await Refresh();
    }

    private async Task DeleteBeyanname(int id)
    {
        var entity = await Db.Beyanname.FindAsync(id);
        if (entity is null) { Message = "Beyanname bulunamadı."; return; }
        Db.Beyanname.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Beyanname silindi.";
        await Refresh();
    }

    private async Task DeleteTahakkuk(int id)
    {
        var entity = await Db.Tahakkuk.FindAsync(id);
        if (entity is null) { Message = "Tahakkuk bulunamadı."; return; }
        Db.Tahakkuk.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Tahakkuk silindi.";
        await Refresh();
    }

    private async Task DeleteOdeme(int id)
    {
        var entity = await Db.Odeme.FindAsync(id);
        if (entity is null) { Message = "Ödeme bulunamadı."; return; }
        Db.Odeme.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Ödeme silindi.";
        await Refresh();
    }
}