@page "/beyannameler"
@using SAT242516026.Data
@using SAT242516026.Models.DbContexts
@using Microsoft.EntityFrameworkCore
@inject MyDbModel_Context Db

<div class="page-scroll">

    <h3 class="mb-3">Beyannameler</h3>

    @if (!string.IsNullOrWhiteSpace(Message))
    {
        <div class="alert alert-info">@Message</div>
    }

    <div class="d-flex gap-2 mb-3">
        <button class="btn btn-outline-secondary" @onclick="Refresh">Yenile</button>
    </div>

    <div class="row g-3">
        <div class="col-lg-5">
            <div class="card mb-4">
                <div class="card-header fw-bold">Beyanname Tipleri</div>
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-8">
                            <input class="form-control" placeholder="Ad*" @bind="bt.Ad" />
                        </div>
                        <div class="col-4">
                            <button class="btn btn-success w-100" @onclick="SaveBeyannameTipi">
                                @(EditBeyannameTipiId is null ? "Ekle" : "Güncelle")
                            </button>
                            @if (EditBeyannameTipiId is not null)
                            {
                                <button class="btn btn-outline-secondary w-100 mt-2" @onclick="CancelBeyannameTipiEdit">İptal</button>
                            }
                        </div>
                    </div>

                    <hr />

                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th style="width:80px;">Id</th>
                                <th>Ad</th>
                                <th style="width:160px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in beyannameTipleri)
                            {
                                <tr>
                                    <td>@t.Id</td>
                                    <td>@t.Ad</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEditBeyannameTipi(t)">Güncelle</button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteBeyannameTipi(t.Id)">Sil</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card mb-4">
                <div class="card-header fw-bold">Beyanname</div>
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-6">
                            <label class="form-label">Mükellef*</label>
                            <select class="form-select" @bind="bn.MukellefId">
                                <option value="0">Seç...</option>
                                @foreach (var m in mukellefler)
                                {
                                    <option value="@m.Id">@m.Ad (@m.Id)</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Beyanname Tipi*</label>
                            <select class="form-select" @bind="bn.BeyannameTipiId">
                                <option value="0">Seç...</option>
                                @foreach (var t in beyannameTipleri)
                                {
                                    <option value="@t.Id">@t.Ad (@t.Id)</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Yıl*</label>
                            <input type="number" class="form-control" @bind="bn.Yil" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Dönem</label>
                            <input class="form-control" placeholder="01, 2025-10, Q3..." @bind="bn.Donem" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Durum</label>
                            <input class="form-control" placeholder="Taslak/Verildi..." @bind="bn.Durum" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Son Gönderme</label>
                            <input type="date" class="form-control" @bind="bn.SonGondermeTarihi" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Gönderme</label>
                            <input type="date" class="form-control" @bind="bn.GondermeTarihi" />
                        </div>

                        <div class="col-md-4">
                            <button class="btn btn-success w-100" @onclick="SaveBeyanname">
                                @(EditBeyannameId is null ? "Ekle" : "Güncelle")
                            </button>
                            @if (EditBeyannameId is not null)
                            {
                                <button class="btn btn-outline-secondary w-100 mt-2" @onclick="CancelBeyannameEdit">İptal</button>
                            }
                        </div>
                    </div>

                    <hr />

                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th style="width:80px;">Id</th>
                                <th>Mükellef</th>
                                <th>Tip</th>
                                <th style="width:90px;">Yıl</th>
                                <th style="width:110px;">Dönem</th>
                                <th>Durum</th>
                                <th style="width:190px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in beyannameler)
                            {
                                <tr>
                                    <td>@b.Id</td>
                                    <td>@b.Mukellef?.Ad (@b.MukellefId)</td>
                                    <td>@b.BeyannameTipi?.Ad (@b.BeyannameTipiId)</td>
                                    <td>@b.Yil</td>
                                    <td>@b.Donem</td>
                                    <td>@b.Durum</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEditBeyanname(b)">Güncelle</button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteBeyanname(b.Id)">Sil</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>

</div>

@code {
    string? Message;

    List<Mukellef> mukellefler = new();
    List<BeyannameTipi> beyannameTipleri = new();
    List<Beyanname> beyannameler = new();

    BeyannameTipi bt = new();
    Beyanname bn = new() { Yil = DateTime.Now.Year };

    int? EditBeyannameTipiId = null;
    int? EditBeyannameId = null;

    protected override async Task OnInitializedAsync() => await Refresh();

    private async Task Refresh()
    {
        try
        {
            mukellefler = await Db.Mukellef
                .OrderByDescending(x => x.Id)
                .Take(50)
                .AsNoTracking()
                .ToListAsync();

            beyannameTipleri = await Db.BeyannameTipi
                .OrderByDescending(x => x.Id)
                .Take(50)
                .AsNoTracking()
                .ToListAsync();

            beyannameler = await Db.Beyanname
                .Include(x => x.Mukellef)
                .Include(x => x.BeyannameTipi)
                .OrderByDescending(x => x.Id)
                .Take(50)
                .AsNoTracking()
                .ToListAsync();

            Message = null;
        }
        catch (Exception ex)
        {
            Message = ex.Message;
        }
        StateHasChanged();
    }

    private void StartEditBeyannameTipi(BeyannameTipi t)
    {
        EditBeyannameTipiId = t.Id;
        bt = new BeyannameTipi { Ad = t.Ad };
        Message = "Beyanname Tipi düzenleme modunda.";
    }

    private void CancelBeyannameTipiEdit()
    {
        EditBeyannameTipiId = null;
        bt = new();
        Message = "Düzenleme iptal edildi.";
    }

    private async Task SaveBeyannameTipi()
    {
        if (string.IsNullOrWhiteSpace(bt.Ad)) { Message = "Beyanname Tipi Ad zorunlu."; return; }

        if (EditBeyannameTipiId is null)
        {
            Db.BeyannameTipi.Add(bt);
            await Db.SaveChangesAsync();
            Message = "Beyanname Tipi eklendi.";
        }
        else
        {
            var entity = await Db.BeyannameTipi.FindAsync(EditBeyannameTipiId.Value);
            if (entity is null) { Message = "Beyanname Tipi bulunamadı."; return; }

            entity.Ad = bt.Ad;
            await Db.SaveChangesAsync();
            Message = "Beyanname Tipi güncellendi.";

            EditBeyannameTipiId = null;
        }

        bt = new();
        await Refresh();
    }

    private async Task DeleteBeyannameTipi(int id)
    {
        var entity = await Db.BeyannameTipi.FindAsync(id);
        if (entity is null) { Message = "Beyanname Tipi bulunamadı."; return; }

        Db.BeyannameTipi.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Beyanname Tipi silindi.";

        if (EditBeyannameTipiId == id)
        {
            EditBeyannameTipiId = null;
            bt = new();
        }

        await Refresh();
    }

    private void StartEditBeyanname(Beyanname b)
    {
        EditBeyannameId = b.Id;

        bn = new Beyanname
            {
                MukellefId = b.MukellefId,
                BeyannameTipiId = b.BeyannameTipiId,
                Yil = b.Yil,
                Donem = b.Donem,
                Durum = b.Durum,
                SonGondermeTarihi = b.SonGondermeTarihi,
                GondermeTarihi = b.GondermeTarihi
            };

        Message = "Beyanname düzenleme modunda.";
    }

    private void CancelBeyannameEdit()
    {
        EditBeyannameId = null;
        bn = new() { Yil = DateTime.Now.Year };
        Message = "Düzenleme iptal edildi.";
    }

    private async Task SaveBeyanname()
    {
        if (bn.MukellefId <= 0 || bn.BeyannameTipiId <= 0 || bn.Yil <= 0)
        { Message = "Mükellef, Tip ve Yıl zorunlu."; return; }

        if (EditBeyannameId is null)
        {
            Db.Beyanname.Add(bn);
            await Db.SaveChangesAsync();
            Message = "Beyanname eklendi.";
        }
        else
        {
            var entity = await Db.Beyanname.FindAsync(EditBeyannameId.Value);
            if (entity is null) { Message = "Beyanname bulunamadı."; return; }

            entity.MukellefId = bn.MukellefId;
            entity.BeyannameTipiId = bn.BeyannameTipiId;
            entity.Yil = bn.Yil;
            entity.Donem = bn.Donem;
            entity.Durum = bn.Durum;
            entity.SonGondermeTarihi = bn.SonGondermeTarihi;
            entity.GondermeTarihi = bn.GondermeTarihi;

            await Db.SaveChangesAsync();
            Message = "Beyanname güncellendi.";

            EditBeyannameId = null;
        }

        bn = new() { Yil = DateTime.Now.Year };
        await Refresh();
    }

    private async Task DeleteBeyanname(int id)
    {
        var entity = await Db.Beyanname.FindAsync(id);
        if (entity is null) { Message = "Beyanname bulunamadı."; return; }

        Db.Beyanname.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Beyanname silindi.";

        if (EditBeyannameId == id)
        {
            EditBeyannameId = null;
            bn = new() { Yil = DateTime.Now.Year };
        }

        await Refresh();
    }
}