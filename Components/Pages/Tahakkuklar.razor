@page "/tahakkuklar"
@using SAT242516026.Data
@using SAT242516026.Models.DbContexts
@using Microsoft.EntityFrameworkCore
@inject MyDbModel_Context Db

<h3 class="mb-3">Tahakkuklar</h3>

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-info">@Message</div>
}

<div class="card mb-4">
    <div class="card-header fw-bold">Tahakkuk</div>
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Beyanname*</label>
                <select class="form-select" @bind="th.BeyannameId">
                    <option value="0">Seç...</option>
                    @foreach (var b in beyannameler)
                    {
                        <option value="@b.Id">#@b.Id - @b.Mukellef?.Ad - @b.BeyannameTipi?.Ad</option>
                    }
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Tutar*</label>
                <input type="number" step="0.01" class="form-control" @bind="th.Tutar" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Tarih</label>
                <input type="date" class="form-control" @bind="th.Tarih" />
            </div>

            <div class="col-md-3">
                <button class="btn btn-success w-100" @onclick="SaveTahakkuk">
                    @(EditTahakkukId is null ? "Ekle" : "Güncelle")
                </button>

                @if (EditTahakkukId is not null)
                {
                    <button class="btn btn-outline-secondary w-100 mt-2" @onclick="CancelTahakkukEdit">İptal</button>
                }
            </div>
        </div>

        <hr />

        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th style="width:80px;">Id</th>
                    <th style="width:120px;">BeyannameId</th>
                    <th>Tutar</th>
                    <th>Tarih</th>
                    <th style="width:190px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in tahakkuklar)
                {
                    <tr>
                        <td>@t.Id</td>
                        <td>@t.BeyannameId</td>
                        <td>@t.Tutar.ToString("C")</td>
                        <td>@t.Tarih?.ToString("yyyy-MM-dd")</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => StartEditTahakkuk(t)">Güncelle</button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTahakkuk(t.Id)">Sil</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    string? Message;

    List<Beyanname> beyannameler = new();
    List<Tahakkuk> tahakkuklar = new();

    Tahakkuk th = new() { Tutar = 0m };

    int? EditTahakkukId = null;

    protected override async Task OnInitializedAsync() => await Refresh();

    private async Task Refresh()
    {
        try
        {
            beyannameler = await Db.Beyanname
                .Include(x => x.Mukellef)
                .Include(x => x.BeyannameTipi)
                .OrderByDescending(x => x.Id)
                .Take(50)
                .AsNoTracking()
                .ToListAsync();

            tahakkuklar = await Db.Tahakkuk
                .OrderByDescending(x => x.Id)
                .Take(50)
                .AsNoTracking()
                .ToListAsync();

            Message = null;
        }
        catch (Exception ex)
        {
            Message = ex.Message;
        }
        StateHasChanged();
    }

    private void StartEditTahakkuk(Tahakkuk t)
    {
        EditTahakkukId = t.Id;

        th = new Tahakkuk
            {
                BeyannameId = t.BeyannameId,
                Tutar = t.Tutar,
                Tarih = t.Tarih
            };

        Message = "Tahakkuk düzenleme modunda.";
    }

    private void CancelTahakkukEdit()
    {
        EditTahakkukId = null;
        th = new() { Tutar = 0m };
        Message = "Düzenleme iptal edildi.";
    }

    private async Task SaveTahakkuk()
    {
        if (th.BeyannameId <= 0) { Message = "Beyanname seç."; return; }
        if (th.Tutar < 0) { Message = "Tutar negatif olamaz."; return; }

        if (EditTahakkukId is null)
        {
            Db.Tahakkuk.Add(th);
            await Db.SaveChangesAsync();
            Message = "Tahakkuk eklendi.";
        }
        else
        {
            var entity = await Db.Tahakkuk.FindAsync(EditTahakkukId.Value);
            if (entity is null) { Message = "Tahakkuk bulunamadı."; return; }

            entity.BeyannameId = th.BeyannameId;
            entity.Tutar = th.Tutar;
            entity.Tarih = th.Tarih;

            await Db.SaveChangesAsync();
            Message = "Tahakkuk güncellendi.";

            EditTahakkukId = null;
        }

        th = new() { Tutar = 0m };
        await Refresh();
    }

    private async Task DeleteTahakkuk(int id)
    {
        var entity = await Db.Tahakkuk.FindAsync(id);
        if (entity is null) { Message = "Tahakkuk bulunamadı."; return; }

        Db.Tahakkuk.Remove(entity);
        await Db.SaveChangesAsync();
        Message = "Tahakkuk silindi.";

        if (EditTahakkukId == id)
        {
            EditTahakkukId = null;
            th = new() { Tutar = 0m };
        }

        await Refresh();
    }
}

